<!--
StoryKeep - Professional Photo Management Platform
Copyright (c) 2025 Calmic Sdn Bhd. All rights reserved.
-->

{% extends "base.html" %}
{% block title %}Photo Animation - StoryKeep{% endblock %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
body {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    min-height: 100vh;
}

.animation-container {
    padding: 2rem 0;
}

.animation-header {
    text-align: center;
    color: white;
    margin-bottom: 2rem;
}

.animation-header h1 {
    font-size: 2.5rem;
    font-weight: 300;
    margin-bottom: 0.5rem;
}

.animation-header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

.opencv-badge {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    color: white;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: bold;
    display: inline-block;
    margin-top: 0.5rem;
}

.preview-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    margin-bottom: 1.5rem;
}

.preview-section {
    text-align: center;
    margin-bottom: 2rem;
}

.preview-image {
    width: 100%;
    max-width: 600px;
    height: auto;
    max-height: 400px;
    object-fit: contain;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.preview-video {
    width: 100%;
    max-width: 600px;
    height: auto;
    max-height: 400px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.controls-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
}

.photo-selector {
    margin-bottom: 2rem;
}

.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.photo-item {
    position: relative;
    cursor: pointer;
    border-radius: 10px;
    overflow: hidden;
    transition: all 0.3s ease;
    border: 3px solid transparent;
}

.photo-item:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.photo-item.selected {
    border-color: #f5576c;
    box-shadow: 0 0 20px rgba(245, 87, 108, 0.5);
}

.photo-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    display: block;
}

.effect-selector {
    margin-bottom: 2rem;
}

.effect-options {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-top: 1rem;
}

.effect-button {
    flex: 1;
    min-width: 150px;
    padding: 1rem;
    background: white;
    border: 2px solid #f5576c;
    color: #f5576c;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    text-align: center;
}

.effect-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
}

.effect-button.active {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-color: transparent;
}

.effect-button i {
    font-size: 2rem;
    display: block;
    margin-bottom: 0.5rem;
}

.animation-settings {
    margin-bottom: 2rem;
}

.setting-group {
    margin-bottom: 1.5rem;
}

.setting-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
}

.setting-group input[type="range"] {
    width: 100%;
}

.setting-group select {
    width: 100%;
    padding: 0.5rem;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
}

.range-value {
    display: inline-block;
    margin-left: 1rem;
    font-weight: 600;
    color: #f5576c;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.btn-animate {
    flex: 1;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-animate:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4);
}

.btn-animate:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.btn-download {
    padding: 1rem 2rem;
    background: white;
    color: #f5576c;
    border: 2px solid #f5576c;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-download:hover {
    background: #f5576c;
    color: white;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 2rem;
}

.spinner {
    border: 4px solid rgba(245, 87, 108, 0.3);
    border-top: 4px solid #f5576c;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.alert {
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-danger {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.effect-description {
    background: rgba(245, 87, 108, 0.1);
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    color: #333;
    font-size: 0.95rem;
}
</style>
{% endblock %}

{% block content %}
<div class="animation-container">
    <div class="container">
        <div class="animation-header">
            <h1><i class="bi bi-film"></i> Photo Animation Studio</h1>
            <p>Bring your photos to life with stunning motion effects</p>
            <div class="opencv-badge">
                <i class="bi bi-cpu"></i> OpenCV Powered
            </div>
        </div>

        <div class="row">
            <div class="col-lg-7">
                <!-- Preview Card -->
                <div class="preview-card">
                    <h5 class="mb-3"><i class="bi bi-eye"></i> Preview</h5>
                    <div class="preview-section" id="previewSection">
                        <div id="imagePreview">
                            <p class="text-muted">Select a photo to begin</p>
                        </div>
                        <div id="videoPreview" style="display: none;">
                            <video id="animationVideo" class="preview-video" controls>
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <!-- Controls Card -->
                <div class="controls-card">
                    <!-- Photo Selector -->
                    <div class="photo-selector">
                        <h5><i class="bi bi-images"></i> Select Photo</h5>
                        <div class="photo-grid" id="photoGrid">
                            {% if photos %}
                                {% for photo in photos %}
                                <div class="photo-item" data-photo-id="{{ photo.id }}" 
                                     data-photo-url="{{ url_for('gallery.uploaded_file', user_id=current_user.id, filename=photo.filename) }}">
                                    <img src="{{ url_for('gallery.uploaded_file', user_id=current_user.id, filename=photo.filename) }}" 
                                         alt="Photo {{ photo.id }}">
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No photos available. Upload photos to get started!</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Effect Selector -->
                    <div class="effect-selector">
                        <h5><i class="bi bi-palette"></i> Animation Effect</h5>
                        <div class="effect-options">
                            <div class="effect-button" data-effect="living">
                                <i class="bi bi-emoji-smile"></i>
                                <div>Living Portrait</div>
                            </div>
                            <div class="effect-button active" data-effect="kenburns">
                                <i class="bi bi-zoom-in"></i>
                                <div>Ken Burns</div>
                            </div>
                            <div class="effect-button" data-effect="parallax">
                                <i class="bi bi-layers"></i>
                                <div>Parallax 3D</div>
                            </div>
                            <div class="effect-button" data-effect="vintage">
                                <i class="bi bi-camera-reels"></i>
                                <div>Vintage</div>
                            </div>
                        </div>
                        <div id="effectDescription" class="effect-description">
                            Classic zoom and pan animation that adds cinematic movement to your photos
                        </div>
                    </div>

                    <!-- Animation Settings -->
                    <div class="animation-settings">
                        <h5><i class="bi bi-sliders"></i> Settings</h5>
                        
                        <div class="setting-group">
                            <label for="duration">Duration: <span class="range-value" id="durationValue">3.0s</span></label>
                            <input type="range" id="duration" min="1" max="10" step="0.5" value="3" class="form-range">
                        </div>

                        <div class="setting-group" id="kenburnsSettings">
                            <label for="zoomDirection">Zoom Direction:</label>
                            <select id="zoomDirection" class="form-select">
                                <option value="in">Zoom In</option>
                                <option value="out">Zoom Out</option>
                            </select>
                        </div>

                        <div class="setting-group" id="panSettings">
                            <label for="panDirection">Pan Direction:</label>
                            <select id="panDirection" class="form-select">
                                <option value="center">Center</option>
                                <option value="left">Left</option>
                                <option value="right">Right</option>
                                <option value="up">Up</option>
                                <option value="down">Down</option>
                            </select>
                        </div>

                        <div class="setting-group">
                            <label for="speed">Speed: <span class="range-value" id="speedValue">1.0x</span></label>
                            <input type="range" id="speed" min="0.5" max="2.0" step="0.1" value="1.0" class="form-range">
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn-animate" id="createAnimationBtn" disabled>
                            <i class="bi bi-play-fill"></i> Create Animation
                        </button>
                    </div>
                    <button class="btn-download" id="downloadBtn" style="display: none; width: 100%; margin-top: 1rem;">
                        <i class="bi bi-download"></i> Download Video
                    </button>

                    <!-- Loading Spinner -->
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner"></div>
                        <p>Creating animation...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const photoGrid = document.getElementById('photoGrid');
    const imagePreview = document.getElementById('imagePreview');
    const videoPreview = document.getElementById('videoPreview');
    const createBtn = document.getElementById('createAnimationBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const effectButtons = document.querySelectorAll('.effect-button');
    const effectDescription = document.getElementById('effectDescription');
    const durationSlider = document.getElementById('duration');
    const speedSlider = document.getElementById('speed');
    const durationValue = document.getElementById('durationValue');
    const speedValue = document.getElementById('speedValue');

    let selectedPhotoId = null;
    let selectedPhotoUrl = null;
    let selectedEffect = 'kenburns';
    let animationUrl = null;

    const effectDescriptions = {
        'living': 'AI-powered facial animation that makes people smile and move naturally',
        'kenburns': 'Classic zoom and pan animation that adds cinematic movement to your photos',
        'parallax': '3D depth effect with layered movement for a dynamic perspective',
        'vintage': 'Nostalgic film-style animation with subtle flickering and grain'
    };

    // Photo selection
    if (photoGrid) {
        photoGrid.addEventListener('click', function(e) {
            const photoItem = e.target.closest('.photo-item');
            if (photoItem) {
                // Remove previous selection
                document.querySelectorAll('.photo-item').forEach(item => {
                    item.classList.remove('selected');
                });

                // Select new photo
                photoItem.classList.add('selected');
                selectedPhotoId = photoItem.dataset.photoId;
                selectedPhotoUrl = photoItem.dataset.photoUrl;

                // Update preview
                imagePreview.innerHTML = `<img src="${selectedPhotoUrl}" class="preview-image" alt="Selected photo">`;
                videoPreview.style.display = 'none';
                downloadBtn.style.display = 'none';

                // Enable create button
                createBtn.disabled = false;
            }
        });
    }

    // Effect selection
    effectButtons.forEach(button => {
        button.addEventListener('click', function() {
            effectButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            selectedEffect = this.dataset.effect;
            effectDescription.textContent = effectDescriptions[selectedEffect];

            // Show/hide settings based on effect
            const kenburnsSettings = document.getElementById('kenburnsSettings');
            const panSettings = document.getElementById('panSettings');
            
            if (selectedEffect === 'kenburns') {
                kenburnsSettings.style.display = 'block';
                panSettings.style.display = 'block';
            } else {
                kenburnsSettings.style.display = 'none';
                panSettings.style.display = 'none';
            }
        });
    });

    // Duration slider
    durationSlider.addEventListener('input', function() {
        durationValue.textContent = this.value + 's';
    });

    // Speed slider
    speedSlider.addEventListener('input', function() {
        speedValue.textContent = this.value + 'x';
    });

    // Create animation
    createBtn.addEventListener('click', async function() {
        if (!selectedPhotoId) {
            alert('Please select a photo first');
            return;
        }

        createBtn.disabled = true;
        loadingSpinner.style.display = 'block';
        downloadBtn.style.display = 'none';

        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            const response = await fetch('/api/animation/create-gif', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    photo_id: parseInt(selectedPhotoId),
                    animation_type: selectedEffect,
                    duration: parseFloat(durationSlider.value),
                    speed: parseFloat(speedSlider.value),
                    zoom_direction: document.getElementById('zoomDirection')?.value,
                    pan_direction: document.getElementById('panDirection')?.value
                })
            });

            const data = await response.json();

            if (data.success) {
                // Show video preview
                animationUrl = data.gif_url;
                const videoElement = document.getElementById('animationVideo');
                videoElement.src = animationUrl;
                
                imagePreview.style.display = 'none';
                videoPreview.style.display = 'block';
                downloadBtn.style.display = 'block';

                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'alert alert-success';
                successMsg.textContent = data.message || 'Animation created successfully!';
                document.querySelector('.controls-card').insertBefore(successMsg, document.querySelector('.photo-selector'));
                setTimeout(() => successMsg.remove(), 5000);
            } else {
                throw new Error(data.error || 'Animation creation failed');
            }
        } catch (error) {
            console.error('Error creating animation:', error);
            const errorMsg = document.createElement('div');
            errorMsg.className = 'alert alert-danger';
            errorMsg.textContent = 'Error: ' + error.message;
            document.querySelector('.controls-card').insertBefore(errorMsg, document.querySelector('.photo-selector'));
            setTimeout(() => errorMsg.remove(), 5000);
        } finally {
            createBtn.disabled = false;
            loadingSpinner.style.display = 'none';
        }
    });

    // Download button
    downloadBtn.addEventListener('click', function() {
        if (animationUrl) {
            const link = document.createElement('a');
            link.href = animationUrl;
            link.download = `animation-${selectedEffect}-${Date.now()}.gif`;
            link.click();
        }
    });
});
</script>
{% endblock %}
