<!--
StoryKeep - Professional Photo Management Platform
Copyright (c) 2025 Calmic Sdn Bhd. All rights reserved.

This software is proprietary and confidential. Unauthorized copying, distribution,
modification, or use of this software is strictly prohibited.

Website: https://www.calmic.com.my
Email: support@calmic.com.my

CALMIC SDN BHD - "Committed to Excellence"
-->

{% extends "base.html" %}
{% from "macros/photo_card.html" import photo_card %}
{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>Dashboard</h1>
        <p class="text-muted">Welcome to your StoryKeep dashboard</p>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
        <div class="card text-white text-center" style="background-color: #3d4451; border: none;">
            <div class="card-body py-4">
                <h2 class="mb-1" style="font-weight: 600; font-size: 2.5rem;">{{ total_photos }}</h2>
                <p class="mb-0" style="font-size: 0.95rem;">Total Photos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card text-white text-center" style="background-color: #5cb85c; border: none;">
            <div class="card-body py-4">
                <h2 class="mb-1" style="font-weight: 600; font-size: 2.5rem;">{{ edited_photos }}</h2>
                <p class="mb-0" style="font-size: 0.95rem;">Edited Photos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card text-white text-center" style="background-color: #5bc0de; border: none;">
            <div class="card-body py-4">
                <h2 class="mb-1" style="font-weight: 600; font-size: 2.5rem;">{{ original_photos }}</h2>
                <p class="mb-0" style="font-size: 0.95rem;">Original Photos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card text-white text-center" style="background-color: #f0ad4e; border: none;">
            <div class="card-body py-4">
                <h2 class="mb-1" style="font-weight: 600; font-size: 2.5rem;">{{ storage_used_mb }}</h2>
                <p class="mb-0" style="font-size: 0.95rem;">Storage (MB)</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h6 class="mb-3">Storage Usage</h6>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: {{ storage_percent }}%; background-color: #5bc0de;" 
                         aria-valuenow="{{ storage_percent }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
                <p class="text-muted mt-2 mb-0" style="font-size: 0.9rem;">
                    {{ storage_used_mb }} MB used of {{ storage_limit_mb }} MB limit
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <a href="{{ url_for('gallery.photos') }}" class="btn btn-dark active">
                <i class="fas fa-images me-1"></i> All Photos
            </a>
            <a href="{{ url_for('gallery.originals') }}" class="btn btn-outline-secondary">
                <i class="fas fa-camera me-1"></i> Original Only
            </a>
            <a href="{{ url_for('gallery.edited') }}" class="btn btn-outline-secondary">
                <i class="fas fa-edit me-1"></i> Edited Only
            </a>
            <a href="{{ url_for('gallery.compare') }}" class="btn btn-outline-info">
                Compare
            </a>
            <button class="btn btn-success" onclick="downloadAll()">
                <i class="fas fa-download me-1"></i> Download All
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Recent Photos</h3>
            {% if photos %}
            <a href="{{ url_for('gallery.photos') }}" class="btn btn-sm btn-outline-primary">
                View All â†’
            </a>
            {% endif %}
        </div>
        {% if photos %}
            <div class="photo-grid">
                {% for photo in photos %}
                {{ photo_card(photo, show_checkbox=False, show_badges=True) }}
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-images fa-4x text-muted mb-3"></i>
                <h4>No photos yet</h4>
                <p class="text-muted">Start by taking your first photo or uploading some files!</p>
                <a href="{{ url_for('upload.upload_page') }}" class="btn btn-primary">
                    <i class="fas fa-camera me-2"></i>Get Started
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script>
function showPhotoPreview(photoId) {
    const photoCard = document.querySelector('[data-photo-id="' + photoId + '"]');
    if (!photoCard) return;
    
    const img = photoCard.querySelector('img');
    const imageSrc = img ? img.getAttribute('data-full-src') || img.src : '';
    const photoName = photoCard.querySelector('.photo-overlay h6') ? photoCard.querySelector('.photo-overlay h6').textContent : 'Photo';
    
    showDashboardPreview(photoId, imageSrc, photoName);
}

function showDashboardPreview(photoId, imageSrc, photoName) {
    // Create preview modal for dashboard photos
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = '<div class="modal-dialog modal-xl">' +
        '<div class="modal-content">' +
            '<div class="modal-header">' +
                '<h5 class="modal-title">' + photoName + '</h5>' +
                '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
            '</div>' +
            '<div class="modal-body text-center p-4">' +
                '<img src="' + imageSrc + '" class="img-fluid rounded shadow-sm" style="max-height: 70vh; max-width: 100%; object-fit: contain;">' +
            '</div>' +
            '<div class="modal-footer justify-content-center">' +
                '<a href="' + imageSrc + '" class="btn btn-success me-2" download="' + photoName + '">' +
                    '<i class="bi bi-download me-1"></i>Download Photo' +
                '</a>' +
                '<div class="btn-group">' +
                    '<button class="btn btn-outline-secondary" onclick="galleryZoomIn(this)" title="Zoom In">' +
                        '<i class="bi bi-zoom-in"></i>' +
                    '</button>' +
                    '<button class="btn btn-outline-secondary" onclick="galleryZoomOut(this)" title="Zoom Out">' +
                        '<i class="bi bi-zoom-out"></i>' +
                    '</button>' +
                    '<button class="btn btn-outline-secondary" onclick="galleryResetZoom(this)" title="Fit to Screen">' +
                        '<i class="bi bi-aspect-ratio"></i>' +
                    '</button>' +
                '</div>' +
                '<a href="{{ url_for("gallery.photos") }}" class="btn btn-outline-primary ms-2">' +
                    '<i class="bi bi-images me-1"></i>View All Photos' +
                '</a>' +
            '</div>' +
        '</div>' +
    '</div>';
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}

function galleryZoomIn(button) {
    const img = button.closest('.modal-content').querySelector('img');
    const currentTransform = img.style.transform || 'scale(1)';
    const scaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
    const currentScale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;
    const newScale = Math.min(currentScale * 1.2, 3);
    img.style.transform = 'scale(' + newScale + ')';
    img.style.transformOrigin = 'center';
}

function galleryZoomOut(button) {
    const img = button.closest('.modal-content').querySelector('img');
    const currentTransform = img.style.transform || 'scale(1)';
    const scaleMatch = currentTransform.match(/scale\(([^)]+)\)/);
    const currentScale = scaleMatch ? parseFloat(scaleMatch[1]) : 1;
    const newScale = Math.max(currentScale / 1.2, 0.5);
    img.style.transform = 'scale(' + newScale + ')';
    img.style.transformOrigin = 'center';
}

function galleryResetZoom(button) {
    const img = button.closest('.modal-content').querySelector('img');
    img.style.transform = 'scale(1)';
}

function viewFullscreen(photoId) {
    const photoCard = document.querySelector('[data-photo-id="' + photoId + '"]');
    if (photoCard) {
        const img = photoCard.querySelector('img');
        const imgSrc = img.src;
        const photoName = photoCard.querySelector('.card-title').textContent;
        
        // Create fullscreen modal
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = '<div class="modal-dialog modal-fullscreen">' +
            '<div class="modal-content bg-dark">' +
                '<div class="modal-header border-0">' +
                    '<h5 class="modal-title text-white">' + photoName + '</h5>' +
                    '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>' +
                '</div>' +
                '<div class="modal-body d-flex justify-content-center align-items-center p-0">' +
                    '<img src="' + imgSrc + '" class="img-fluid" style="max-height: 90vh; max-width: 90vw; object-fit: contain;">' +
                '</div>' +
                '<div class="modal-footer border-0 justify-content-center">' +
                    '<div class="btn-group">' +
                        '<button class="btn btn-outline-light btn-sm" onclick="galleryZoomIn(this)">' +
                            '<i class="bi bi-zoom-in"></i>' +
                        '</button>' +
                        '<button class="btn btn-outline-light btn-sm" onclick="galleryZoomOut(this)">' +
                            '<i class="bi bi-zoom-out"></i>' +
                        '</button>' +
                        '<button class="btn btn-outline-light btn-sm" onclick="galleryResetZoom(this)">' +
                            '<i class="bi bi-aspect-ratio"></i>' +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Clean up modal after hiding
        modal.addEventListener('hidden.bs.modal', function() {
            document.body.removeChild(modal);
        });
    }
}

function deletePhoto(photoId) {
    if (confirm('Are you sure you want to delete this photo? This action cannot be undone.')) {
        fetch('/gallery/delete/' + photoId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload the page to refresh the dashboard
                location.reload();
            } else {
                alert('Error deleting photo: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting photo. Please try again.');
        });
    }
}

function downloadAll() {
    window.location.href = '{{ url_for("gallery.download_all") }}';
}
</script>
{% endblock %}